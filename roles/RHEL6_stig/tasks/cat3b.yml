- name: "LOW | V-38579 | PATCH | The system boot loader configuration file(s) must be owned by root."
  file:
    path: /boot/grub/grub.conf
    owner: root
  tags:
    - cat3
    - low
    - V-38579
    - grub
    - patch

- name: "LOW | V-38580 | PATCH | The audit system must be configured to audit the loading and unloading of dynamic kernel modules."
  lineinfile:
    line: "{{ item }}"
    dest: /etc/audit/audit.rules
  with_items:
    - "-w /sbin/insmod -p x -k modules"
    - "-w /sbin/rmmod -p x -k modules"
    - "-w /sbin/modprobe -p x -k modules"
    - "-a always,exit -F arch={{ audit_arch }} -S init_module -S delete_module -k modules"
  tags:
    - cat3
    - low
    - V-38580
    - auditd
    - patch
  
- name: "LOW | V-38581 | PATCH | The system boot loader configuration file(s) must be group-owned by root."
  file:
    path: /boot/grub/grub.conf
    group: root
  tags:
    - cat3
    - low
    - V-38581
    - grub
    - patch

- name: "LOW | V-38582 | PATCH | The xinetd service must be disabled if no network services utilizing it are enabled"
  service:
    name: xinetd
    state: stopped
    enabled: no
  when: "'xinetd' in sysv_services.stdout"
  tags:
    - cat3
    - low
    - V-38582
    - xinetd
    - network
    - patch

- name: "LOW | V-38583 | PATCH | The system boot loader configuration file(s) must have mode 0600 or less permissive." 
  file:
    path: /boot/grub/grub.conf
    mode: 'u-x,g-rwx,o-rwx'
  tags:
    - cat3
    - low
    - V-38583
    - grub
    - patch

- name: "LOW | V-38584 | AUDIT | The xinetd service must be uninstalled if no network services utilizing it are enabled."
  command: rpm -q xinetd
  register: pkgs_xinetd_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38584
      - xinetd
      - audit

- name: "LOW | V-38584 | PATCH | The xinetd service must be uninstalled if no network services utilizing it are enabled."
  yum:
      name: xinetd
      state: absent
  tags:
      - cat3
      - low
      - V-38584
      - xinetd
      - patch

# V-38590 install screen
- name: "LOW | V-38590 | AUDIT | The system must allow locking of the console screen in text mode."
  command: rpm -q screen
  register: pkgs_screen_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38590
      - screen_lock
      - screen
      - audit

- name: "LOW | V-38590 | PATCH | The system must allow locking of the console screen in text mode."
  yum:
      name: screen
      state: present
  tags:
      - cat3
      - low
      - V-38590
      - screen_lock
      - screen
      - patch

# V-38608 sshd conf
- name: "LOW | V-38608 | AUDIT | The SSH daemon must set a timeout interval on idle sessions."
  shell: grep ClientAliveInterval /etc/ssh/sshd_config | awk '{print $2}'
  register: sshd_client_alive_interval_audit
  always_run: yes
  tags:
      - cat3
      - low
      - V-38608
      - ssh
      - audit

- name: "LOW | V-38608 | PATCH | The SSH daemon must set a timeout interval on idle sessions."
  lineinfile:
    state: present 
    backup: yes 
    dest: /etc/ssh/sshd_config 
    regexp: '^(#)?ClientAliveInterval' 
    line: ClientAliveInterval 900
  when: sshd_client_alive_interval_audit.stdout|int < 900
  tags:
      - cat3
      - low
      - V-38608
      - ssh
      - patch
  notify: restart ssh

- name: "LOW | V-38610 | PATCH | The SSH daemon must set a timeout count on idle sessions."
  lineinfile:
    state: present
    backup: yes
    dest: /etc/ssh/sshd_config
    regexp: '^(#)?ClientAliveCountMax'
    line: ClientAliveCountMax 0
  tags:
      - cat3
      - low
      - V-38610
      - ssh
      - patch
  notify: restart ssh

- name: "LOW | V-38616 | PATCH | The SSH daemon must not permit user environment settings."
  lineinfile:
    state: present
    backup: yes
    dest: /etc/ssh/sshd_config
    regexp: '^(#)?PermitUserEnvironment'
    line: PermitUserEnvironment no
  tags:
      - cat3
      - low
      - V-38616
      - ssh
      - patch
  notify: restart ssh

# V-38618 avahi-daemon
- name: "LOW | V-38618 | AUDIT | The avahi service must be disabled."
  command: chkconfig 'avahi-daemon' --list
  register: avahi_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38618
      - avahi
      - services
      - audit

- name: "LOW | V-38618 | AUDIT | The avahi service must be disabled."
  command: service avahi-daemon status
  register: avahi_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38618
      - avahi
      - services
      - audit

- name: "LOW | V-38618 | PATCH | The avahi service must be disabled."
  service:
      name: avahi-daemon
      state: stopped
      enabled: no
  when: "':on' in avahi_service_enabled_audit or avahi_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38618
      - avahi
      - services
      - patch

# V-38627 remove openldap-server
- name: "LOW | V-38627 | AUDIT | The openldap-servers package must not be installed unless required."
  command: rpm -q openldap-servers
  register: pkgs_openldap_server_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38627
      - openldap_server
      - audit

- name: "LOW | V-38627 | PATCH | The openldap-servers package must not be installed unless required."
  yum:
      name: openldap-servers
      state: absent
  when: not rhel6stig_openldap_server_required
  tags:
      - cat3
      - low
      - V-38627
      - openldap_server
      - audit

# V-38635 auditd adjtimex

# V-38639 gconf screensaver

# V-38640 abrtd service
- name: "LOW | V-38640 | AUDIT | The Automatic Bug Reporting Tool (abrtd) service must not be running."
  command: chkconfig 'abrtd' --list
  register: abrtd_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38640
      - abrtd
      - services
      - audit

- name: "LOW | V-38640 | AUDIT | The Automatic Bug Reporting Tool (abrtd) service must not be running."
  command: service abrtd status
  register: abrtd_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38640
      - abrtd
      - services
      - audit

- name: "LOW | V-38640 | PATCH | The Automatic Bug Reporting Tool (abrtd) service must not be running."
  service:
      name: abrtd
      state: stopped
      enabled: no
  when: "':on' in abrtd_service_enabled_audit or abrtd_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38640
      - abrtd
      - services
      - patch

# V-38641 atd service
- name: "LOW | V-38641 | AUDIT | The atd service must be disabled."
  command: chkconfig 'atd' --list
  register: atd_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38641
      - atd
      - services
      - audit

- name: "LOW | V-38641 | AUDIT | The atd service must be disabled."
  command: service atd status
  register: atd_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38641
      - atd
      - services
      - audit

- name: "LOW | V-38641 | PATCH | The atd service must be disabled."
  service:
      name: atd
      state: stopped
      enabled: no
  when: "':on' in atd_service_enabled_audit or atd_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38641
      - atd
      - services
      - patch

# V-38642 umask

# V-38644 ntpdate service
- name: "LOW | V-38644 | AUDIT | The ntpdate service must not be running."
  command: chkconfig 'ntpdate' --list
  register: ntpdate_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38644
      - ntpdate
      - services
      - audit

- name: "LOW | V-38644 | AUDIT | The ntpdate service must not be running."
  command: service ntpdate status
  register: ntpdate_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38644
      - ntpdate
      - services
      - audit

- name: "LOW | V-38644 | PATCH | The ntpdate service must not be running."
  service:
      name: ntpdate
      state: stopped
      enabled: no
  when: "':on' in ntpdate_service_enabled_audit or ntpdate_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38644
      - ntpdate
      - services
      - patch

# V-38645 login.defs umask
- name: "LOW | V-38645 | PATCH | The system default umask in /etc/login.defs must be 077."
  replace:
      dest: /etc/login.defs
      regexp: '^UMASK.*'
      replace: 'UMASK           077'
  tags:
      - cat3
      - low
      - V-38645
      - umask
      - patch

# V-38646 oddjobd service
- name: "LOW | V-38646 | AUDIT | The oddjobd service must not be running."
  command: chkconfig 'oddjobd' --list
  register: oddjobd_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38646
      - oddjobd
      - services
      - audit

- name: "LOW | V-38646 | AUDIT | The oddjobd service must not be running."
  command: service oddjobd status
  register: oddjobd_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38646
      - oddjobd
      - services
      - audit

- name: "LOW | V-38646 | PATCH | The oddjobd service must not be running."
  service:
      name: oddjobd
      state: stopped
      enabled: no
  when: "':on' in oddjobd_service_enabled_audit or oddjobd_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38646
      - oddjobd
      - services
      - patch

# V-38647 profile umask
- name: "LOW | V-38647 | PATCH | The system default umask in /etc/profile must be 077."
  replace:
      dest: /etc/profile
      regexp: 'umask \d\d\d'
      replace: 'umask 077'
  tags:
      - cat3
      - low
      - V-38647
      - umask
      - patch

# V-38648 qpidd
- name: "LOW | V-38648 | AUDIT | The qpidd service must not be running."
  command: chkconfig 'qpidd' --list
  register: qpidd_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38648
      - qpidd
      - services
      - audit

- name: "LOW | V-38648 | AUDIT | The qpidd service must not be running."
  command: service qpidd status
  register: qpidd_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38648
      - qpidd
      - services
      - audit

- name: "LOW | V-38648 | PATCH | The qpidd service must not be running."
  service:
      name: qpidd
      state: stopped
      enabled: no
  when: "':on' in qpidd_service_enabled_audit or qpidd_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38648
      - qpidd
      - services
      - patch

# V-38649 csh umask
- name: "LOW | V-38649 | PATCH | The system default umask for the csh shell must be 077."
  replace:
      dest: /etc/csh.cshrc
      regexp: 'umask \d\d\d'
      replace: 'umask 077'
  tags:
      - cat3
      - low
      - V-38649
      - umask
      - patch

# V-38650 rdisc service
- name: "LOW | V-38650 | AUDIT | The rdisc service must not be running."
  command: chkconfig 'rdisc' --list
  register: rdisc_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38650
      - rdisc
      - services
      - audit

- name: "LOW | V-38650 | AUDIT | The rdisc service must not be running."
  command: service rdisc status
  register: rdisc_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38650
      - rdisc
      - services
      - audit

- name: "LOW | V-38650 | PATCH | The rdisc service must not be running."
  service:
      name: rdisc
      state: stopped
      enabled: no
  when: "':on' in rdisc_service_enabled_audit or rdisc_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38650
      - rdisc
      - services
      - patch

# V-38651 bash umask
- name: "LOW | V-38651 | PATCH | The system default umask for the bash shell must be 077."
  replace:
      dest: /etc/bashrc
      regexp: 'umask \d\d\d'
      replace: 'umask 077'
  tags:
      - cat3
      - low
      - V-38651
      - umask
      - patch

# V-38656 smb client signing
- name: "LOW | V-38656 | PATCH | The system must use SMB client signing for connecting to samba servers using smbclient."
  lineinfile:
      state: present
      dest: /etc/samba/smb.conf
      regexp: '^#?client signing'
      line: 'client signing = mandatory'
      insertafter: '^\[global\]'
  when: samba_check.stat.exists
  notify: restart samba
  tags:
      - cat3
      - low
      - V-38656
      - smb
      - patch

# V-38669 postfix service
- name: "LOW | V-38669 | AUDIT | The postfix service must be enabled for mail delivery."
  command: chkconfig 'postfix' --list
  register: postfix_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38669
      - postfix
      - services
      - audit

- name: "LOW | V-38669 | AUDIT | The postfix service must be enabled for mail delivery."
  command: service postfix status
  register: postfix_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38669
      - postfix
      - services
      - audit

- name: "LOW | V-38669 | PATCH | The postfix service must be enabled for mail delivery."
  service:
      name: postfix
      state: started
      enabled: yes
  when: postfix_service_running_audit.rc == 0
  tags:
      - cat3
      - low
      - V-38669
      - postfix
      - services
      - patch

# V-38672 netconsole service
- name: "LOW | V-38672 | AUDIT | The netconsole service must be disabled unless required."
  command: chkconfig 'netconsole' --list
  register: netconsole_service_enabled_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38672
      - netconsole
      - services
      - audit

- name: "LOW | V-38672 | AUDIT | The netconsole service must be disabled unless required."
  command: service netconsole status
  register: netconsole_service_running_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38672
      - netconsole
      - services
      - audit

- name: "LOW | V-38672 | PATCH | The netconsole service must be disabled unless required."
  service:
      name: netconsole
      state: stopped
      enabled: no
  when: "':on' in netconsole_service_enabled_audit or netconsole_service_running_audit.rc == 0"
  tags:
      - cat3
      - low
      - V-38672
      - netconsole
      - services
      - patch

# V-38675 limits core
- name: "LOW | V-38675 | PATCH | Process core dumps must be disabled unless needed."
  lineinfile:
      state: present
      dest: /etc/security/limits.conf
      regexp: '^#?\\*.*core'
      line: '*                hard    core            0'
      insertbefore: '^# End of file'
  tags:
      - cat3
      - low
      - V-38675
      - core_dump
      - patch

# V-38676 remove x11
- name: "LOW | V-38676 | AUDIT | The xorg-x11-server-common (X Windows) package must not be installed, unless required."
  command: rpm -qi xorg-x11-server-common
  register: pkgs_xwindows_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38676
      - xwindows
      - audit

- name: "LOW | V-38676 | PATCH | The xorg-x11-server-common (X Windows) package must not be installed, unless required."
  yum:
      name: "@X Window System"
      state: absent
  when: not rhel6stig_xwindows_required
  tags:
      - cat3
      - low
      - V-38676
      - xwindows
      - audit

# V-38684 limits maxlogins
- name: "LOW | V-38684 | PATCH | The system must limit users to 10 simultaneous system logins, or a site-defined number, in accordance with operational requirements."
  lineinfile:
      state: present
      dest: /etc/security/limits.conf
      regexp: '^#?\\*.*maxlogins'
      line: '*                hard    maxlogins       {{ rhel6stig_maxlogins }}'
      insertbefore: '^# End of file'
  tags:
      - cat3
      - low
      - V-38684
      - logon_settings
      - patch

# V-38687 openswan install
- name: "LOW | V-38687 | AUDIT | The system must provide VPN connectivity for communications over untrusted networks."
  command: rpm -q openswan
  register: pkgs_vpn_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38687
      - openswan
      - vpn
      - audit

- name: "LOW | V-38687 | PATCH | The system must provide VPN connectivity for communications over untrusted networks."
  yum:
      name: openswan
      state: present
  tags:
      - cat3
      - low
      - V-38687
      - openswan
      - vpn
      - patch

# V-38692 inactive acct set
- name: "LOW | V-V-38692 | PATCH | Accounts must be locked upon 35 days of inactivity."
  lineinfile:
      state: present
      dest: /etc/default/useradd
      regexp: '^#?INACTIVE='
      line: 'INACTIVE={{ rhel6stig_acct_max_inactive }}'
  tags:
      - cat3
      - low
      - V-38692
      - account
      - patch

# V-38694 inactive acct set
- name: "LOW | V-V-38694 | PATCH | The operating system must manage information system identifiers for users and devices by disabling the user identifier after an organization defined time period of inactivity."
  lineinfile:
      state: present
      dest: /etc/default/useradd
      regexp: '^#?INACTIVE='
      line: 'INACTIVE={{ rhel6stig_acct_max_inactive }}'
  tags:
      - cat3
      - low
      - V-38694
      - account
      - patch

# V-38702 ftp logging
- name: "LOW | V-38702 | AUDIT | The FTP daemon must be configured for logging or verbose mode."
  command: rpm -q vsftpd
  register: vsftpd_service_installed_audit
  changed_when: false
  failed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-38702
      - logging
      - ftp
      - audit

- name: "LOW | V-38702 | AUDIT | The FTP daemon must be configured for logging or verbose mode."
  command: grep -l vsftpd /etc/xinetd.d/*
  register: vsftpd_xinetd_startup_file_audit
  changed_when: false
  failed_when: false
  always_run: yes
  when: vsftpd_service_installed_audit.stdout.find('not installed') == -1
  tags:
      - cat3
      - low
      - V-38702
      - logging
      - ftp
      - audit

- name: "LOW | V-38702 | AUDIT | The FTP daemon must be configured for logging or verbose mode."
  command: grep server_args {{ vsftpd_xinetd_startup_file_audit.stdout }}
  register: vsftpd_config_file_audit
  changed_when: false
  failed_when: false
  when: vsftpd_service_installed_audit.stdout.find('not installed') == -1 and vsftpd_xinetd_startup_file_audit.stdout
  always_run: yes
  tags:
      - cat3
      - low
      - V-38702
      - logging
      - ftp
      - audit

- name: "LOW | V-38702 | AUDIT | The FTP daemon must be configured for logging or verbose mode."
  command: "grep '^xferlog_enable' {{ vsftpd_config_file_audit.stdout | default('/etc/vsftpd/vsftpd.conf') }}"
  register: vsftpd_xinetd_config_file_audit
  changed_when: false
  failed_when: false
  always_run: yes
  when: vsftpd_service_installed_audit.stdout.find('not installed') == -1
  tags:
      - cat3
      - low
      - V-38702
      - logging
      - ftp
      - audit

- name: "LOW | V-38702 | PATCH | The FTP daemon must be configured for logging or verbose mode."
  lineinfile:
      state: present
      backup: no
      dest: "{{ vsftpd_config_file_audit.stdout | default('/etc/vsftpd/vsftpd.conf') }}"
      regexp: '^#?xferlog_enable'
      line: 'xferlog_enable=YES'
  when: vsftpd_service_installed_audit.stdout.find('not installed') == -1
  tags:
      - cat3
      - low
      - V-38702
      - logging
      - ftp
      - audit
  notify: restart vsftpd

# V-51369 selinux
- name: "LOW | V-51369 | AUDIT | The system must use a Linux Security Module configured to limit the privileges of system services."
  command: grep '^SELINUXTYPE' /etc/selinux/config
  register: selinux_policy_audit
  failed_when: selinux_policy_audit.rc == 2
  changed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-51369
      - selinux
      - audit

- name: "LOW | V-51369 | PATCH | The system must use a Linux Security Module configured to limit the privileges of system services."
  selinux:
      policy: targeted
      state: enforcing
  tags:
      - cat3
      - low
      - V-51369
      - selinux
      - patch

# V-51379 selinux
- name: "LOW | V-51379 | AUDIT | All device files must be monitored by the system Linux Security Module."
  shell: ls -RZ /dev | grep unlabeled_t
  register: selinux_device_file_context_audit
  failed_when: false
  changed_when: false
  always_run: yes
  tags:
      - cat3
      - low
      - V-51379
      - secontext
      - audit

- name: "LOW | V-51379 | PATCH | All device files must be monitored by the system Linux Security Module."
  command: restorecon -r /dev/
  register: selinux_device_file_context_patch
  when: selinux_device_file_context_audit.rc == 0
  failed_when: selinux_device_file_context_patch.rc != 0
  changed_when: selinux_device_file_context_patch.stdout
  tags:
      - cat3
      - low
      - V-51379
      - secontext
      - patch

# --- BREAK --- #

- name: V-38642 Low  The system default umask for daemons must be 027 or 022
  lineinfile: state=present backup=yes dest=/etc/init.d/functions regexp="umask \d\d\d" line="umask 022"
  tags: [ 'cat3' , 'V-38642' , 'umask' ]

- name: V-38608 Low  The SSH daemon must set a timeout interval on idle sessions
  lineinfile: "state=present backup=yes dest=/etc/ssh/sshd_config regexp='^(#)?ClientAliveInterval' line='ClientAliveInterval 900'"
  tags: [ 'cat3' , 'V-38608' , 'ssh' ]
  notify: restart ssh

- name: Use strong MAC algorithms
  lineinfile: "state=present backup=yes dest=/etc/ssh/sshd_config regexp='^#?MACS' line='MACS    hmac-sha1,umac-64@openssh.com,hmac-ripemd160,hmac-sha2-256,hmac-sha2-512'"
  tags: [ 'cat3' , 'ssh' , 'config' ]
  notify: restart ssh
